<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Climate Hazard Outlook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --low:#2c7bb6;
  --lowmedium:#abd9e9;
  --mediumhigh:#fdae61;
  --high:#f46d43;
  --extreme:#d73027;
  --track:#e6e9ee;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:Inter,sans-serif}
body{margin:0}
#map{height:100vh}

/* PANEL */
.panel{
  position:absolute;
  top:20px;
  left:20px;
  width:260px;
  background:#fff;
  padding:14px;
  border-radius:12px;
  box-shadow:0 12px 28px rgba(0,0,0,.18);
  z-index:1000;
}
.panel input{
  width:100%;
  padding:8px 10px;
  margin-bottom:8px;
  border-radius:6px;
  border:1px solid #d1d5db;
  font-size:14px;
}
.panel button{
  width:100%;
  padding:10px;
  border-radius:6px;
  border:none;
  background:#2563eb;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.panel .hint{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  z-index:2000;
}
.popup.show{display:block}

.popup-card{
  background:#fff;
  width:1100px;
  max-width:95%;
  margin:40px auto;
  padding:32px;
  border-radius:18px;
  position:relative;
}
.close{
  position:absolute;
  right:18px;
  top:14px;
  font-size:26px;
  cursor:pointer;
}

/* GAUGES */
.gauges{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:32px;
}
.gauge{text-align:center}

.title{
  display:flex;
  justify-content:center;
  gap:6px;
  font-weight:600;
}
.info{cursor:pointer;color:#64748b}

/* TOOLTIP */
.tooltip{
  position:fixed;
  background:#111827;
  color:#fff;
  padding:10px 12px;
  border-radius:8px;
  font-size:12px;
  width:260px;
  line-height:1.4;
  z-index:9999;
  display:none;
}

svg{width:200px}
.arc{transition:.3s}
.label{font-weight:700;font-size:18px}
.sub{color:#6b7280;font-size:13px}

@media(max-width:900px){
  .gauges{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>

<body>

<div id="map"></div>

<!-- PANEL -->
<div class="panel">
  <input id="lat" value="25.663651">
  <input id="lon" value="85.139280">
  <button onclick="getRisk()">Calculate Climate Risk</button>
  <div class="hint">ðŸ–± Click anywhere on the map to assess risk</div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-card">
    <span class="close" onclick="closePopup()">Ã—</span>

    <div class="gauges">

      <!-- WATER STRESS -->
      <div class="gauge">
        <div class="title">Water Stress
          <span class="info" data-tip="Ratio of total annual water withdrawals to available renewable water supply. Arid & low-use basins are shown separately. Source: WRI Aqueduct v4">â“˜</span>
        </div>
        <svg viewBox="0 0 200 120">
          <path d="M20 100 A80 80 0 0 1 180 100" stroke="var(--track)" stroke-width="14" fill="none"/>
          <path id="arc-water" class="arc" d="M20 100 A80 80 0 0 1 180 100" stroke-width="14" fill="none"/>
        </svg>
        <div id="label-water" class="label">â€“</div>
        <div id="value-water" class="sub"></div>
      </div>

      <!-- DROUGHT -->
      <div class="gauge">
        <div class="title">Drought
          <span class="info" data-tip="Frequency, duration, and severity of drought events. Source: WRI Aqueduct v4">â“˜</span>
        </div>
        <svg viewBox="0 0 200 120">
          <path d="M20 100 A80 80 0 0 1 180 100" stroke="var(--track)" stroke-width="14" fill="none"/>
          <path id="arc-drought" class="arc" d="M20 100 A80 80 0 0 1 180 100" stroke-width="14" fill="none"/>
        </svg>
        <div id="label-drought" class="label">â€“</div>
        <div id="value-drought" class="sub"></div>
      </div>

      <!-- RIVER FLOOD -->
      <div class="gauge">
        <div class="title">River Flood
          <span class="info" data-tip="Modeled flood depth, frequency, and exposure. Source: WRI Aqueduct v4">â“˜</span>
        </div>
        <svg viewBox="0 0 200 120">
          <path d="M20 100 A80 80 0 0 1 180 100" stroke="var(--track)" stroke-width="14" fill="none"/>
          <path id="arc-river" class="arc" d="M20 100 A80 80 0 0 1 180 100" stroke-width="14" fill="none"/>
        </svg>
        <div id="label-river" class="label">â€“</div>
        <div id="value-river" class="sub"></div>
      </div>

      <!-- COASTAL FLOOD -->
      <div class="gauge">
        <div class="title">Coastal Flood
          <span class="info" data-tip="Exposure to sea-level rise and storm surge. Coastal only. Source: WRI Aqueduct v4">â“˜</span>
        </div>
        <svg viewBox="0 0 200 120">
          <path d="M20 100 A80 80 0 0 1 180 100" stroke="var(--track)" stroke-width="14" fill="none"/>
          <path id="arc-coastal" class="arc" d="M20 100 A80 80 0 0 1 180 100" stroke-width="14" fill="none"/>
        </svg>
        <div id="label-coastal" class="label">â€“</div>
        <div id="value-coastal" class="sub"></div>
      </div>

    </div>
  </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marker;
const tooltip = document.getElementById("tooltip");

/* TOOLTIP */
document.querySelectorAll(".info").forEach(el=>{
  el.addEventListener("mouseenter",e=>{
    tooltip.innerText = e.target.dataset.tip;
    tooltip.style.display = "block";
    const r = e.target.getBoundingClientRect();
    tooltip.style.top = (r.top - tooltip.offsetHeight - 10) + "px";
    tooltip.style.left = (r.left + r.width/2 - tooltip.offsetWidth/2) + "px";
  });
  el.addEventListener("mouseleave",()=>tooltip.style.display="none");
});

/* GAUGE RENDER (UPDATED) */
function renderGauge(score, arcId, labelId, valueId, isWaterStress=false){
  const arc=document.getElementById(arcId);
  const label=document.getElementById(labelId);
  const value=document.getElementById(valueId);

  // âœ… WRI special category
  if(isWaterStress && Number(score) === -1){
    arc.style.stroke="var(--track)";
    arc.style.strokeDasharray="0 251";
    label.innerText="Arid & Low Water Use";
    value.innerText="WRI-defined category";
    return;
  }

  // Missing data
  if(score==null){
    arc.style.stroke="var(--track)";
    arc.style.strokeDasharray="0 251";
    label.innerText="Not Available";
    value.innerText="";
    return;
  }

  const s=Number(score);
  const dash=251*Math.min(s/5,1);

  let txt,color;
  if(s<=1){txt="Low";color="var(--low)";}
  else if(s<=2){txt="Lowâ€“Medium";color="var(--lowmedium)";}
  else if(s<=3){txt="Mediumâ€“High";color="var(--mediumhigh)";}
  else if(s<=4){txt="High";color="var(--high)";}
  else{txt="Extremely High";color="var(--extreme)";}

  arc.style.stroke=color;
  arc.style.strokeDasharray=`${dash} 251`;
  label.innerText=txt;
  value.innerText=`Score: ${s.toFixed(2)} / 5`;
}

function closePopup(){
  document.getElementById("popup").classList.remove("show");
}

/* BUTTON */
async function getRisk(){
  const lat=Number(document.getElementById("lat").value);
  const lon=Number(document.getElementById("lon").value);

  const res=await fetch(`/risk?lat=${lat}&lon=${lon}`);
  const d=await res.json();
  const s=d.scores;

  renderGauge(s.water_stress_category,"arc-water","label-water","value-water",true);
  renderGauge(s.drought_risk_score,"arc-drought","label-drought","value-drought");
  renderGauge(s.river_flood_risk_score,"arc-river","label-river","value-river");
  renderGauge(s.coastal_flood_risk_score,"arc-coastal","label-coastal","value-coastal");

  document.getElementById("popup").classList.add("show");
}

/* MAP CLICK */
map.on("click", async e=>{
  const lat=e.latlng.lat.toFixed(6);
  const lon=((((e.latlng.lng+180)%360+360)%360)-180).toFixed(6);

  document.getElementById("lat").value=lat;
  document.getElementById("lon").value=lon;

  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],7);

  await getRisk();
});
</script>

</body>
</html>
