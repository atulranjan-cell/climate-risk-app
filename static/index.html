<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Climate Risk Scan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* ================= GLOBAL ================= */
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  color: #111;
}

/* ================= NAV ================= */
nav {
  background: rgba(255,255,255,0.95);
  padding: 16px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}
nav .logo {
  font-weight: 800;
  font-size: 20px;
}
nav a {
  margin-left: 24px;
  text-decoration: none;
  font-weight: 600;
  color: #333;
}
nav a:hover { color: #1e90ff; }

/* ================= SECTIONS ================= */
section {
  max-width: 1400px;
  margin: 40px auto;
  padding: 0 20px;
}
.card {
  background: #fff;
  border-radius: 16px;
  padding: 28px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.18);
}

/* ================= HERO ================= */
#home {
  text-align: center;
  color: white;
  padding: 80px 20px;
}
#home h1 {
  font-size: 52px;
  margin-bottom: 16px;
}
#home p {
  font-size: 20px;
  opacity: 0.9;
}
#home button {
  margin-top: 32px;
  padding: 16px 36px;
  font-size: 18px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: linear-gradient(135deg,#1e90ff,#0f6fd9);
  color: #fff;
}

/* ================= MAP ================= */
#map {
  height: 420px;
  border-radius: 14px;
  margin-bottom: 20px;
}

/* ================= CONTROLS ================= */
.controls {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}
input {
  padding: 12px;
  border-radius: 10px;
  border: 2px solid #e2e6ea;
  font-size: 15px;
  width: 160px;
}
input[readonly] {
  background: #f5f6f8;
  user-select: none;
  caret-color: transparent;
}
button.primary {
  padding: 12px 26px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
  font-weight: 700;
  background: linear-gradient(135deg,#1e90ff,#0f6fd9);
  color: white;
  cursor: pointer;
}
button.primary:disabled { opacity: 0.5; }

/* ================= STATUS ================= */
#status {
  margin-top: 16px;
  padding: 12px;
  border-radius: 10px;
  font-weight: 600;
}
.loading { background:#fff3cd; }
.error { background:#f8d7da; }
.success { background:#d4edda; }

/* ================= MODAL ================= */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.modal {
  background: white;
  width: min(96vw,1200px);
  max-height: 85vh;
  overflow-y: auto;
  border-radius: 18px;
  padding: 26px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.4);
}
.close-btn {
  float: right;
  font-size: 28px;
  background: none;
  border: none;
  cursor: pointer;
}

/* ================= TABLE COLORS ================= */
.color-5 { background:#d73027;color:#fff }
.color-4 { background:#f46d43;color:#fff }
.color-3 { background:#fdae61 }
.color-2 { background:#abd9e9 }
.color-1 { background:#d1f2eb }
.color-0 { background:#f8f9fa }

/* ================= FAQ ================= */
#faq h3 { margin-top: 24px; }
#faq p { color:#555; }
</style>
</head>

<body>

<nav>
  <div class="logo">üåç Climate Risk</div>
  <div>
    <a href="#home">Home</a>
    <a href="#product">Product</a>
    <a href="#faq">FAQ</a>
  </div>
</nav>

<section id="home">
  <h1>Free Climate Risk Scan</h1>
  <p>Site-specific climate hazard assessment using ERA5, CMIP6 & Aqueduct</p>
  <button onclick="document.getElementById('product').scrollIntoView({behavior:'smooth'})">
    Start Free Scan
  </button>
</section>

<section id="product">
  <div class="card">
    <h2>Select a location</h2>
    <div id="map"></div>

    <div class="controls">
      <input id="lat" placeholder="Latitude" readonly>
      <input id="lon" placeholder="Longitude" readonly>
      <input id="city" placeholder="City (optional)">
      <button id="computeBtn" class="primary" disabled onclick="compute()">üöÄ Compute Risk</button>
    </div>

    <div id="status"></div>
  </div>
</section>

<section id="faq">
  <div class="card">
    <h2>FAQ</h2>

    <h3>What does this tool calculate?</h3>
    <p>It evaluates chronic and extreme climate hazards including heat, cold, drought, flood, cyclone, wildfire and water stress.</p>

    <h3>What datasets are used?</h3>
    <p>ERA5 (observed), CMIP6 (future scenarios), WRI Aqueduct, IPCC AR6 sea-level multipliers.</p>

    <h3>How long does one location take?</h3>
    <p>Typically <b>3‚Äì10 minutes per location</b>, depending on model complexity and data availability.</p>

    <h3>Is this free?</h3>
    <p>This scan is free for exploration and early risk screening.</p>
  </div>
</section>

<!-- ================= MODAL ================= -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <button class="close-btn" onclick="closeModal()">√ó</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
let map, marker=null;

function initMap(){
  map = L.map('map',{center:[20,0],zoom:2});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© OpenStreetMap'
  }).addTo(map);

  map.on('click', e=>{
    const lat=e.latlng.lat.toFixed(5);
    const lon=e.latlng.lng.toFixed(5);
    const latI=document.getElementById('lat');
    const lonI=document.getElementById('lon');

    latI.value=lat;
    lonI.value=lon;
    latI.blur(); lonI.blur();
    window.getSelection()?.removeAllRanges();

    if(marker) marker.setLatLng(e.latlng);
    else marker=L.marker(e.latlng).addTo(map);

    document.getElementById('computeBtn').disabled=false;
    showStatus(`üìç Location selected: ${lat}, ${lon}`,'success');
  });
}

function showStatus(msg,type){
  const s=document.getElementById('status');
  s.textContent=msg;
  s.className=type;
}

async function compute(){
  const lat=lat.value, lon=lon.value, city=city.value.trim();
  showStatus('üîÑ Computing climate risk‚Ä¶','loading');

  try{
    const res=await fetch(`/run?lat=${lat}&lon=${lon}&city=${encodeURIComponent(city)}`);
    const json=await res.json();
    renderTable(json.data,json.columns,city,lat,lon);
    showStatus('‚úÖ Completed','success');
  }catch(e){
    showStatus('‚ùå Error computing risk','error');
  }
}

function openModal(){ modalOverlay.style.display='flex'; }
function closeModal(){ modalOverlay.style.display='none'; }

function scoreClass(v){
  if(v==null) return 'color-0';
  if(v>=4) return 'color-5';
  if(v>=3) return 'color-4';
  if(v>=2) return 'color-3';
  if(v>=1) return 'color-2';
  return 'color-1';
}

function renderTable(data,cols,city,lat,lon){
  modalContent.innerHTML=`
    <h3>${city||'Selected Location'} (${lat},${lon})</h3>
    <table id="hazardTable" class="display" style="width:100%"></table>`;
  openModal();

  $('#hazardTable').DataTable({
    data:data,
    columns:cols.map((c,i)=>({
      title:c,
      data:c,
      render:(v)=> i===0?`<b>${v}</b>`:
        `<div class="${scoreClass(v)}" style="text-align:center">${v?.toFixed?.(2)||'‚Äî'}</div>`
    })),
    paging:false,
    scrollX:true
  });
}

document.addEventListener('DOMContentLoaded',initMap);
</script>

</body>
</html>
