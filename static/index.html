<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Climate Hazard Matrix</title>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      max-width: 1400px; margin: 0 auto; padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }
    .card {
      background: white; border-radius: 12px; padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px;
    }
    #map {
      height: 420px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .controls {
      display: flex; gap: 15px; align-items: end; flex-wrap: wrap;
      margin: 20px 0;
    }
    input {
      padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px;
      font-size: 16px; width: 160px;
    }
    input[readonly] { background: #f5f6f8; }
    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #1e90ff, #0f6fd9);
      color: white; border: none; border-radius: 8px;
      font-size: 16px; font-weight: 600;
      cursor: pointer;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #status {
      margin: 15px 0; padding: 12px;
      border-radius: 8px; font-weight: 600;
    }
    .loading { background: #fff3cd; color: #856404; }
    .error { background: #f8d7da; color: #721c24; }
    .success { background: #d4edda; color: #155724; }

    table.dataTable { font-size: 13px; }
    .color-5 { background:#d73027;color:#fff }
    .color-4 { background:#f46d43;color:#fff }
    .color-3 { background:#fdae61 }
    .color-2 { background:#abd9e9 }
    .color-1 { background:#d1f2eb }
    .color-0 { background:#f8f9fa }
  </style>
</head>

<body>
<div class="card">
  <h1>Climate Hazard Matrix</h1>
  <p style="color:#666">Click on the map to select a location</p>

  <!-- MAP -->
  <div id="map"></div>

  <!-- CONTROLS -->
  <div class="controls">
    <input id="lat" placeholder="Latitude" readonly>
    <input id="lon" placeholder="Longitude" readonly>
    <input id="city" placeholder="City (optional)">
    <button id="computeBtn" onclick="compute()" disabled>ðŸš€ Compute Hazards</button>
  </div>

  <div id="status"></div>

  <!-- RESULTS -->
  <div class="card" id="results" style="display:none">
    <h3 id="resultsTitle"></h3>
    <table id="hazardTable" class="display" style="width:100%">
      <thead><tr><th>Hazard</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let map, marker = null;
let isComputing = false;

/* ---------------- MAP ---------------- */
function initMap() {
  map = L.map('map', { center:[20,0], zoom:2 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Â© OpenStreetMap'
  }).addTo(map);

  map.on('click', e => {
    const lat = e.latlng.lat.toFixed(5);
    const lon = e.latlng.lng.toFixed(5);

    document.getElementById('lat').value = lat;
    document.getElementById('lon').value = lon;

    if (marker) marker.setLatLng(e.latlng);
    else marker = L.marker(e.latlng).addTo(map);

    document.getElementById('computeBtn').disabled = false;
    showStatus(`ðŸ“ Location selected: ${lat}, ${lon}`, 'success');
  });
}

/* ---------------- COMPUTE ---------------- */
async function compute() {
  if (isComputing) return;

  const lat = document.getElementById('lat').value;
  const lon = document.getElementById('lon').value;
  const city = document.getElementById('city').value.trim();

  if (!lat || !lon) {
    showStatus('â— Click on the map first', 'error');
    return;
  }

  isComputing = true;
  const btn = document.getElementById('computeBtn');
  btn.disabled = true;
  btn.textContent = 'â³ Computing...';
  showStatus('ðŸ”„ Fetching climate data...', 'loading');

  try {
    const cityParam = city ? `&city=${encodeURIComponent(city)}` : '';
    const res = await fetch(`/run?lat=${lat}&lon=${lon}${cityParam}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (!json.success) throw new Error(json.error);

    renderTable(json.data, json.columns, city, lat, lon);
    showStatus('âœ… Computation complete', 'success');
    document.getElementById('results').style.display = 'block';
  } catch (e) {
    showStatus(`âŒ ${e.message}`, 'error');
  } finally {
    isComputing = false;
    btn.disabled = false;
    btn.textContent = 'ðŸš€ Compute Hazards';
  }
}

/* ---------------- TABLE ---------------- */
function scoreClass(v){
  if(v==null) return 'color-0';
  if(v>=4) return 'color-5';
  if(v>=3) return 'color-4';
  if(v>=2) return 'color-3';
  if(v>=1) return 'color-2';
  return 'color-1';
}

function renderTable(data, columns, city, lat, lon){
  if ($.fn.DataTable.isDataTable('#hazardTable')) {
    $('#hazardTable').DataTable().destroy();
  }

  $('#hazardTable thead tr').html(
    '<th>Hazard</th>' + columns.slice(1).map(c=>`<th>${c}</th>`).join('')
  );

  const rows = data.map(r=>{
    let t = `<tr><td><b>${r.Hazard}</b></td>`;
    for(let i=1;i<columns.length;i++){
      const v = r[columns[i]];
      t += `<td class="${scoreClass(v)}" style="text-align:center">
        ${v==null?'â€”':v.toFixed(2)}
      </td>`;
    }
    return t+'</tr>';
  }).join('');

  $('#hazardTable tbody').html(rows);

  $('#hazardTable').DataTable({
    paging:false,
    scrollX:true,
    order:[[0,'asc']]
  });

  document.getElementById('resultsTitle').textContent =
    `${city || 'Selected Location'} (${lat}, ${lon})`;
}

/* ---------------- STATUS ---------------- */
function showStatus(msg,type){
  const s=document.getElementById('status');
  s.textContent=msg;
  s.className=type;
}

/* INIT */
document.addEventListener('DOMContentLoaded', initMap);
</script>
</body>
</html>
